# azure-pipelines.yml
# This pipeline builds and deploys a Python web app to Azure App Service.

# This pipeline is triggered by:
# 1. A push to the 'main' branch of this repository.
# 2. The completion of the infrastructure pipeline.
trigger:
- main

resources:
  pipelines:
  - pipeline: infra_pipeline # An alias for the resource
    # the actual name of the infrastructure pipeline
    source: 'infra-chatbot-ai' 
    trigger: true # Trigger this pipeline when the source pipeline completes

pr: none # Disable pull request triggers

variables:
  # Define pipeline variables
  azureSubscription: 'connection-chatbot-dev' # IMPORTANT: Update this
  azureWebAppName: 'app-RG-Chatbot-AzureAI1'
  pythonVersion: '3.10'
  vmImageName: 'ubuntu-latest'

stages:
- stage: Build
  displayName: Build stage
  jobs:
  - job: Build
    displayName: Build and Archive
    pool:
      vmImage: $(vmImageName)
    steps:
    - checkout: self

    - task: UsePythonVersion@0
      inputs:
        versionSpec: '$(pythonVersion)'
      displayName: 'Set up Python $(pythonVersion)'

    - script: |
        python -m venv venv
        source venv/bin/activate
        pip install -r requirements.txt
      displayName: 'Install dependencies (for local validation)'

    - script: chmod +x startup.sh
      displayName: 'Make startup.sh executable'

    - task: ArchiveFiles@2
      displayName: 'Archive source code for deployment'
      inputs:
        rootFolderOrFile: '$(System.DefaultWorkingDirectory)'
        includeRootFolder: false
        archiveType: 'zip'
        archiveFile: '$(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip'
        replaceExistingArchive: true
        # Exclude files not needed for deployment
        exclude: |
          venv/**
          __pycache__/**
          .git/**

    - publish: '$(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip'
      artifact: drop

- stage: Deploy
  displayName: 'Deploy Application to Dev'
  dependsOn: Build
  condition: succeeded()
  jobs:
  - deployment: DeployWebApp
    displayName: Deploy to Web App
    environment: 'Production'
    pool:
      vmImage: $(vmImageName)
    strategy:
      runOnce:
        deploy:
          steps:
          - task: AzureWebApp@1
            displayName: 'Deploy Azure Web App'
            inputs:
              azureSubscription: '$(azureSubscription)'
              appType: 'webAppLinux'
              appName: '$(azureWebAppName)'
              package: '$(Pipeline.Workspace)/drop/$(Build.BuildId).zip'
              runtimeStack: 'PYTHON|$(pythonVersion)'
              # These settings are equivalent to your azure/appservice-settings steps
              appSettings: |
                -SCM_DO_BUILD_DURING_DEPLOYMENT true
                -STARTUP_COMMAND "bash startup.sh"
                -AZURE_OPENAI_KEY "$(AZURE_OPENAI_KEY)"
                -AZURE_OPENAI_ENDPOINT "$(AZURE_OPENAI_ENDPOINT)"
                -AZURE_OPENAI_DEPLOYMENT "$(AZURE_OPENAI_DEPLOYMENT)"
                -FLASK_ENV "production"
